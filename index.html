<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新标签页</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.loli.net">
    <link rel="preconnect" href="https://gstatic.loli.net" crossorigin>
    <link href="https://fonts.loli.net/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'system-ui', '-apple-system', 'sans-serif'] },
                    animation: { 'fade-in-down': 'fadeInDown 0.3s ease-out forwards', 'fade-in-up': 'fadeInUp 0.6s ease-out forwards' },
                    keyframes: {
                        fadeInDown: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        body { font-family: 'Outfit', sans-serif; transition: background-image 0.5s ease, background-color 0.5s ease, color 0.3s ease; }
        .glass-panel { @apply backdrop-blur-md bg-white/60 border border-white/40 dark:bg-slate-800/60 dark:border-slate-700/50; }
        
        input[type="search"]::-webkit-search-decoration,
        input[type="search"]::-webkit-search-cancel-button,
        input[type="search"]::-webkit-search-results-button,
        input[type="search"]::-webkit-search-results-decoration { display: none; }
        
        .dragging { opacity: 0.4; transform: scale(0.95); }

        /* 主题定义 */
        .theme-light { @apply bg-gray-50 text-gray-800; }
        .theme-dark { @apply bg-slate-900 text-slate-100; }
        .theme-blue { @apply bg-gradient-to-br from-blue-50 to-indigo-100 text-slate-800 dark:from-slate-900 dark:to-indigo-950 dark:text-slate-100; }
        .theme-green { @apply bg-gradient-to-br from-emerald-50 to-teal-100 text-teal-900 dark:from-slate-900 dark:to-emerald-950 dark:text-slate-100; }
        .theme-purple { @apply bg-gradient-to-br from-fuchsia-50 to-purple-100 text-purple-900 dark:from-slate-900 dark:to-purple-950 dark:text-slate-100; }
        .theme-warm { @apply bg-gradient-to-br from-orange-50 to-amber-100 text-orange-900 dark:from-slate-900 dark:to-orange-950 dark:text-slate-100; }

        .avatar-bg-0 { @apply bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-200; }
        .avatar-bg-1 { @apply bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-200; }
        .avatar-bg-2 { @apply bg-amber-100 text-amber-600 dark:bg-amber-900/50 dark:text-amber-200; }
        .avatar-bg-3 { @apply bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-200; }
        .avatar-bg-4 { @apply bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-200; }
        .avatar-bg-5 { @apply bg-cyan-100 text-cyan-600 dark:bg-cyan-900/50 dark:text-cyan-200; }
        .avatar-bg-6 { @apply bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-200; }
        .avatar-bg-7 { @apply bg-purple-100 text-purple-600 dark:bg-purple-900/50 dark:text-purple-200; }
    </style>
</head>
<body id="app-body" class="min-h-screen font-sans overflow-x-hidden flex flex-col theme-light">

    <!-- 顶部导航 -->
    <header class="w-full px-6 py-4 flex flex-col z-20 relative">
        <div class="flex items-center justify-between w-full">
            <div id="btn-cloud-sync" onclick="openCloudModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-full glass-panel cursor-pointer hover:bg-white/80 dark:hover:bg-slate-700/80 transition-all select-none group shadow-sm">
                <div class="relative flex items-center justify-center">
                    <i data-lucide="cloud" class="w-4 h-4 opacity-70 group-hover:text-blue-500 transition-colors"></i>
                    <span id="cloud-dot" class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-gray-400 rounded-full border border-white dark:border-slate-800"></span>
                </div>
                <span id="cloud-text" class="text-xs font-bold opacity-80">未连接</span>
            </div>

            <div class="flex items-center gap-3">
                <div id="date-display" class="text-sm font-medium opacity-60 hidden md:block select-none"></div>
                <button id="btn-edit" class="p-2 rounded-full transition-all duration-300 bg-white/50 hover:bg-white/80 dark:bg-slate-700/50 dark:hover:bg-slate-600 shadow-sm" title="设置 / 编辑布局">
                    <i data-lucide="settings-2" class="w-5 h-5 opacity-70"></i>
                </button>
            </div>
        </div>

        <!-- 编辑模式控制台 (已扩展) -->
        <div id="edit-panel" class="hidden w-full mt-4 animate-fade-in-down absolute top-14 left-0 px-4 z-30">
            <div class="glass-panel rounded-2xl p-4 border shadow-xl flex flex-col gap-4 max-w-lg mx-auto backdrop-blur-xl">
                <!-- 第一行：风格 & 操作 -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-bold opacity-50 uppercase tracking-widest shrink-0">风格</span>
                        <div class="flex gap-2">
                            <button onclick="changeTheme('theme-light')" class="w-5 h-5 rounded-full border border-gray-300 bg-gray-50 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="雅白"></button>
                            <button onclick="changeTheme('theme-dark')" class="w-5 h-5 rounded-full border border-slate-600 bg-slate-900 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="深邃"></button>
                            <button onclick="changeTheme('theme-blue')" class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-300 to-indigo-300 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="极光"></button>
                            <button onclick="changeTheme('theme-green')" class="w-5 h-5 rounded-full bg-gradient-to-br from-emerald-300 to-teal-300 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="森系"></button>
                            <button onclick="changeTheme('theme-purple')" class="w-5 h-5 rounded-full bg-gradient-to-br from-fuchsia-300 to-purple-300 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="梦幻"></button>
                            <button onclick="changeTheme('theme-warm')" class="w-5 h-5 rounded-full bg-gradient-to-br from-orange-300 to-amber-300 ring-2 ring-transparent hover:ring-blue-400 focus:ring-blue-500 transition-all shadow-sm" title="暖阳"></button>
                        </div>
                    </div>
                    <div class="w-full h-px bg-gray-400/20 sm:w-px sm:h-6 hidden sm:block"></div>
                    <div class="flex items-center gap-3 w-full sm:w-auto justify-end">
                        <button onclick="resetData()" class="px-3 py-1.5 text-xs font-medium rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors border border-red-100 dark:bg-red-900/20 dark:border-red-900/30 dark:text-red-300 whitespace-nowrap">重置</button>
                        <button id="btn-done" class="px-4 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs shadow-md transition-transform active:scale-95 flex items-center gap-1.5 whitespace-nowrap">
                            <i data-lucide="check" class="w-3.5 h-3.5"></i> 完成
                        </button>
                    </div>
                </div>

                <!-- 第二行：图标仓库设置 -->
                <div class="pt-3 border-t border-gray-200 dark:border-slate-700">
                    <label class="block text-[10px] font-bold opacity-60 uppercase tracking-widest mb-1">Github 图标仓库前缀 (Base URL)</label>
                    <div class="flex gap-2">
                        <input id="input-base-url" type="text" placeholder="https://raw.githubusercontent.com/ZInBeta/start-page/main/icons/" class="flex-1 p-2 text-xs rounded-lg bg-gray-50 dark:bg-slate-900/50 border border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none font-mono text-gray-600 dark:text-gray-300" onchange="window.saveBaseUrl(this.value)">
                        <button onclick="window.saveBaseUrl(document.getElementById('input-base-url').value)" class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold transition-colors">保存</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">设置后，添加图标时只需填写文件名 (如 bing.png)，系统会自动拼接。</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 主体内容 -->
    <main id="main-container" class="flex-1 container mx-auto px-4 flex flex-col justify-center items-center max-w-6xl py-10 transition-all duration-300">
        
        <div id="greeting-section" class="text-center mb-12 animate-fade-in-up">
            <h1 id="clock-time" class="text-7xl md:text-9xl font-semibold tracking-tight mb-2 tabular-nums cursor-default select-none opacity-90">00:00</h1>
            <p id="greeting-text" class="text-lg md:text-xl font-normal opacity-60">Loading...</p>
        </div>

        <div id="search-container" class="w-full max-w-2xl mb-12 relative group z-10 transition-all duration-300">
            <form id="search-form" class="relative">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none opacity-40">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </div>
                <input id="search-input" type="text" placeholder="Search Bing..." class="w-full pl-14 pr-36 py-4 rounded-full text-lg shadow-lg shadow-blue-900/5 hover:shadow-xl focus:shadow-2xl transition-all duration-300 outline-none border border-transparent focus:border-blue-500/30 bg-white/80 placeholder-gray-400 dark:bg-slate-800 dark:text-white dark:placeholder-gray-500">
                
                <div class="absolute inset-y-0 right-2 flex items-center gap-1">
                    <div class="flex items-center p-1 rounded-full bg-gray-100/50 dark:bg-slate-700/50">
                        <button type="button" data-engine="bing" class="engine-btn px-3 py-1 rounded-full text-xs font-bold transition-all duration-200">B</button>
                        <button type="button" data-engine="google" class="engine-btn px-3 py-1 rounded-full text-xs font-bold transition-all duration-200">G</button>
                    </div>
                    <div class="w-px h-4 bg-gray-300/50 mx-1"></div>
                    <button type="button" onclick="openFinanceModal()" class="p-2 rounded-full hover:bg-green-50 text-gray-400 hover:text-green-600 transition-colors dark:hover:bg-green-900/30 dark:hover:text-green-400" title="我的钱包">
                        <i data-lucide="wallet" class="w-4 h-4"></i>
                    </button>
                </div>
            </form>
        </div>

        <div id="shortcuts-container" class="w-full grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-8 gap-x-4 gap-y-6 justify-items-center animate-fade-in-up pb-20" style="animation-delay: 0.1s;">
            <!-- JS 生成 -->
        </div>
    </main>

    <footer class="fixed bottom-0 w-full p-4 text-center pointer-events-none opacity-40 text-xs">
        Designed for Focus & Efficiency
    </footer>

    <!-- 弹窗：添加/编辑链接 -->
    <div id="modal-add-link" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4 dark:text-white">添加快捷方式</h3>
            <form id="form-add-link" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">名称</label>
                    <input id="input-link-name" type="text" placeholder="例如: Github" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-700 border-transparent focus:bg-white dark:focus:bg-slate-600 border focus:border-blue-500 outline-none transition-all dark:text-white" required>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">网址</label>
                    <input id="input-link-url" type="text" placeholder="github.com" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-slate-700 border-transparent focus:bg-white dark:focus:bg-slate-600 border focus:border-blue-500 outline-none transition-all dark:text-white" required>
                </div>
                
                <!-- 自定义图标区域 -->
                <div class="p-3 bg-gray-50 dark:bg-slate-700/50 rounded-xl border border-gray-100 dark:border-slate-600">
                    <label class="block text-sm font-medium mb-3 dark:text-slate-300">自定义图标</label>
                    
                    <!-- 方式一：图片链接 -->
                    <div class="mb-3">
                        <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">方式A：图标文件名 或 完整链接</label>
                        <input id="input-icon-url" type="text" placeholder="例如: bing.png (如果设置了前缀)" class="w-full p-2 text-xs rounded-lg border border-gray-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:border-blue-500 outline-none font-mono" oninput="window.handleUrlInput(this.value)">
                        <p class="text-[10px] text-blue-500 mt-1 hidden" id="base-url-hint">已启用前缀拼接，可直接输入文件名。</p>
                    </div>

                    <div class="flex items-center gap-2 mb-2 text-[10px] text-gray-400 uppercase font-bold text-center">
                        <div class="h-px bg-gray-200 dark:bg-slate-600 flex-1"></div>
                        <span>OR</span>
                        <div class="h-px bg-gray-200 dark:bg-slate-600 flex-1"></div>
                    </div>

                    <!-- 方式二：本地上传 -->
                    <div class="flex items-center gap-3">
                        <label class="cursor-pointer flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white dark:bg-slate-600 border border-gray-200 dark:border-slate-500 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-500 transition-colors">
                            <i data-lucide="upload" class="w-4 h-4 text-gray-500 dark:text-gray-300"></i>
                            <span class="text-xs text-gray-600 dark:text-gray-300">方式B：上传本地图片 (转Base64)</span>
                            <input type="file" id="input-link-icon-file" class="hidden" accept="image/*" onchange="window.handleIconUpload(event)">
                        </label>
                    </div>

                    <!-- 预览区 -->
                    <div class="mt-3 flex items-center gap-3">
                        <div id="preview-icon" class="w-10 h-10 rounded-full border bg-white overflow-hidden hidden shrink-0 shadow-sm">
                            <img src="" class="w-full h-full object-contain">
                        </div>
                        <span id="upload-status" class="text-xs text-gray-400 truncate">未选择图标 (默认使用 Google 图标)</span>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" id="btn-cancel-add" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">取消</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 弹窗：财务概览 -->
    <div id="modal-finance" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in-up p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold dark:text-white flex items-center gap-2"><i data-lucide="wallet" class="w-5 h-5 text-green-500"></i> 财务概览</h3>
                <button onclick="window.closeFinanceModal()" class="opacity-50 hover:opacity-100 dark:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 rounded-2xl bg-gray-50 dark:bg-slate-700 text-center"><div class="text-xs text-gray-400 mb-1 font-bold">本月支出</div><div class="text-xl font-bold text-gray-800 dark:text-white" id="modal-finance-spent">¥0</div></div>
                <div class="p-4 rounded-2xl bg-green-50 dark:bg-green-900/20 text-center"><div class="text-xs text-green-600/70 dark:text-green-400 mb-1 font-bold">当前余额</div><div class="text-xl font-bold text-green-600 dark:text-green-400" id="modal-finance-balance">¥0</div></div>
            </div>
            <form id="form-finance" class="flex gap-2 border-t border-gray-100 dark:border-slate-700 pt-5">
                <input id="input-balance" type="number" step="0.01" placeholder="最新余额" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-slate-700 outline-none font-mono font-bold dark:text-white" required>
                <button type="submit" class="px-5 py-3 rounded-xl bg-black dark:bg-white dark:text-black text-white font-bold transition-transform active:scale-95">更新</button>
            </form>
        </div>
    </div>

    <!-- 弹窗：云同步配置 -->
    <div id="modal-cloud-config" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in-up p-6">
            <h3 class="text-xl font-bold mb-2 dark:text-white">云端同步配置 (Firebase)</h3>
            <p class="text-xs text-gray-500 mb-4">填写配置后，你的链接和记账数据将跨设备自动同步。数据加密存储在 Google Cloud。</p>
            <div id="cloud-error-msg" class="hidden mb-4 p-3 rounded-lg bg-red-50 text-red-600 text-xs border border-red-100 dark:bg-red-900/30 dark:border-red-900/50 dark:text-red-300"></div>
            <form id="form-cloud-config" class="space-y-3">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">API Key</label><input id="input-firebase-apikey" type="text" class="w-full p-2 text-xs rounded border dark:bg-slate-700 dark:border-slate-600 dark:text-white font-mono" placeholder="AIzaSy..." required></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Project ID</label><input id="input-firebase-projectid" type="text" class="w-full p-2 text-xs rounded border dark:bg-slate-700 dark:border-slate-600 dark:text-white font-mono" required></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">App ID</label><input id="input-firebase-appid" type="text" class="w-full p-2 text-xs rounded border dark:bg-slate-700 dark:border-slate-600 dark:text-white font-mono" required></div>
                </div>
                <div class="flex gap-3 mt-6 pt-2">
                    <button type="button" class="flex-1 py-2 rounded-lg border hover:bg-gray-50 dark:border-slate-600 dark:hover:bg-slate-700 dark:text-slate-300" onclick="document.getElementById('modal-cloud-config').classList.add('hidden')">取消</button>
                    <button type="submit" id="btn-connect-cloud" class="flex-1 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold">连接并同步</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const DEFAULT_SHORTCUTS = [
            { name: 'Bing', url: 'https://www.bing.com/', clicks: 0 }, { name: 'Google', url: 'https://www.google.com/', clicks: 0 },
            { name: 'ChatGPT', url: 'https://chat.openai.com/', clicks: 0 }, { name: 'GitHub', url: 'https://github.com/', clicks: 0 },
            { name: 'Bilibili', url: 'https://www.bilibili.com/', clicks: 0 },
        ];
        const GREETINGS = ["Do what you can, with what you have, where you are.", "Progress, not perfection.", "Small steps, big changes.", "The harder you work, the luckier you get.", "Challenges are what make life interesting and overcoming them is what makes life meaningful.", "Believe you can and you're halfway there."];

        let state = {
            shortcuts: JSON.parse(localStorage.getItem('myShortcuts')) || DEFAULT_SHORTCUTS,
            isEditing: false,
            editingIndex: null,
            searchEngine: 'bing',
            theme: localStorage.getItem('myTheme') || 'theme-light',
            iconBaseUrl: localStorage.getItem('myIconBaseUrl') || '', 
            financeLogs: JSON.parse(localStorage.getItem('myFinanceLogs')) || [],
            tempIconBase64: null,
            firebaseConfig: JSON.parse(localStorage.getItem('myFirebaseConfig')) || null,
            db: null
        };

        function init() {
            applyTheme(state.theme);
            document.getElementById('input-base-url').value = state.iconBaseUrl; 
            // sortShortcuts(); // 移除：由用户拖拽决定顺序
            renderShortcuts();
            updateEngineUI();
            updateClock(); setInterval(updateClock, 1000);
            lucide.createIcons();
            document.getElementById('search-input').focus();
            document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key === 'Tab'){ e.preventDefault(); state.searchEngine = state.searchEngine==='bing'?'google':'bing'; updateEngineUI(); } });

            if (state.firebaseConfig) { initFirebase(state.firebaseConfig); }
        }

        // 移除：自动排序逻辑
        // function sortShortcuts() {
        //    state.shortcuts.sort((a, b) => (b.clicks || 0) - (a.clicks || 0));
        // }

        // 修改：只记录点击，不排序
        window.recordClick = (index) => {
            // 确保 clicks 属性存在
            if (!state.shortcuts[index].clicks) state.shortcuts[index].clicks = 0;
            
            // 增加点击数
            state.shortcuts[index].clicks++;
            
            // 不再调用 sortShortcuts()
            
            // 保存
            saveState();
            // 不需要重新 renderShortcuts，避免页面闪烁
        }

        async function initFirebase(config) {
            updateCloudStatus('connecting');
            const errorBox = document.getElementById('cloud-error-msg');
            errorBox.classList.add('hidden');

            try {
                const app = initializeApp(config);
                const auth = getAuth(app);
                state.db = getFirestore(app);
                await signInAnonymously(auth);
                const docRef = doc(state.db, "users", "my_sync_data_v1");
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        let needRender = false;
                        if(JSON.stringify(data.shortcuts) !== JSON.stringify(state.shortcuts)) {
                            state.shortcuts = data.shortcuts || [];
                            localStorage.setItem('myShortcuts', JSON.stringify(state.shortcuts));
                            // sortShortcuts(); // 移除同步后排序
                            needRender = true;
                        }
                        if(data.iconBaseUrl && data.iconBaseUrl !== state.iconBaseUrl) {
                            state.iconBaseUrl = data.iconBaseUrl;
                            localStorage.setItem('myIconBaseUrl', state.iconBaseUrl);
                            document.getElementById('input-base-url').value = state.iconBaseUrl;
                            needRender = true;
                        }
                        if(JSON.stringify(data.financeLogs) !== JSON.stringify(state.financeLogs)) {
                            state.financeLogs = data.financeLogs || [];
                            localStorage.setItem('myFinanceLogs', JSON.stringify(state.financeLogs));
                        }
                        if(data.theme && data.theme !== state.theme) {
                            state.theme = data.theme;
                            localStorage.setItem('myTheme', state.theme);
                            applyTheme(state.theme);
                        }
                        if(needRender) renderShortcuts();
                        updateCloudStatus('synced');
                        document.getElementById('modal-cloud-config').classList.add('hidden');
                    } else {
                        saveToCloud();
                        updateCloudStatus('synced');
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    showCloudError("同步中断：请检查网络代理。");
                    updateCloudStatus('error');
                });
            } catch (e) {
                console.error("Firebase Init Error", e);
                showCloudError("连接失败：请开启 VPN 代理 googleapis.com，并确保 Firebase 中启用了【匿名登录】。");
                updateCloudStatus('error');
            }
        }

        function showCloudError(msg) {
            const el = document.getElementById('cloud-error-msg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        async function saveToCloud() {
            if (!state.db) return;
            updateCloudStatus('syncing');
            try {
                await setDoc(doc(state.db, "users", "my_sync_data_v1"), {
                    shortcuts: state.shortcuts,
                    financeLogs: state.financeLogs,
                    theme: state.theme,
                    iconBaseUrl: state.iconBaseUrl, 
                    updatedAt: new Date().toISOString()
                });
                updateCloudStatus('synced');
            } catch(e) { console.error(e); updateCloudStatus('error'); }
        }

        function updateCloudStatus(status) {
            const text = document.getElementById('cloud-text');
            const dot = document.getElementById('cloud-dot');
            if (status === 'connecting') { text.innerText = '连接中'; dot.className = "absolute -top-0.5 -right-0.5 w-2 h-2 bg-yellow-400 rounded-full border border-white animate-pulse"; }
            else if (status === 'synced') { text.innerText = '已同步'; dot.className = "absolute -top-0.5 -right-0.5 w-2 h-2 bg-green-500 rounded-full border border-white"; }
            else if (status === 'syncing') { text.innerText = '同步中'; dot.className = "absolute -top-0.5 -right-0.5 w-2 h-2 bg-blue-500 rounded-full border border-white animate-pulse"; }
            else { text.innerText = '未连接'; dot.className = "absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full border border-white"; }
        }

        document.getElementById('form-cloud-config').addEventListener('submit', (e) => {
            e.preventDefault();
            const config = {
                apiKey: document.getElementById('input-firebase-apikey').value.trim(),
                authDomain: `${document.getElementById('input-firebase-projectid').value.trim()}.firebaseapp.com`,
                projectId: document.getElementById('input-firebase-projectid').value.trim(),
                storageBucket: `${document.getElementById('input-firebase-projectid').value.trim()}.appspot.com`,
                messagingSenderId: "123456789", 
                appId: document.getElementById('input-firebase-appid').value.trim()
            };
            localStorage.setItem('myFirebaseConfig', JSON.stringify(config));
            state.firebaseConfig = config;
            initFirebase(config);
        });

        // --- 核心逻辑 ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});
            document.getElementById('date-display').innerText = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            document.getElementById('greeting-text').innerText = GREETINGS[dayOfYear % GREETINGS.length];
        }

        function saveState() {
            localStorage.setItem('myShortcuts', JSON.stringify(state.shortcuts));
            saveToCloud();
        }

        // --- UI 操作 ---
        window.changeTheme = (themeName) => {
            state.theme = themeName;
            localStorage.setItem('myTheme', themeName);
            applyTheme(themeName);
            saveToCloud();
        }

        window.saveBaseUrl = (url) => {
            state.iconBaseUrl = url.trim();
            localStorage.setItem('myIconBaseUrl', state.iconBaseUrl);
            saveToCloud();
            alert("图标前缀已保存！\n现在添加图标时，可以直接填写文件名了 (例如: bing.png)。");
            renderShortcuts(); 
        }

        function applyTheme(themeName) {
            const body = document.getElementById('app-body');
            body.className = `min-h-screen font-sans overflow-x-hidden flex flex-col ${themeName}`;
            if (themeName === 'theme-dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }

        window.openCloudModal = () => document.getElementById('modal-cloud-config').classList.remove('hidden');
        window.openFinanceModal = () => { document.getElementById('modal-finance').classList.remove('hidden'); const l=state.financeLogs; const last=l.length>0?l[l.length-1]:{balance:0}; document.getElementById('modal-finance-balance').innerText='¥ '+parseFloat(last.balance).toLocaleString(); document.getElementById('input-balance').focus(); };
        window.closeFinanceModal = () => document.getElementById('modal-finance').classList.add('hidden');
        window.deleteLink = (i) => { if(confirm("确定删除?")) { state.shortcuts.splice(i,1); saveState(); renderShortcuts(); } };
        
        window.openEditLinkModal = (i) => {
            state.editingIndex = i;
            const link = state.shortcuts[i];
            
            document.getElementById('modal-title').innerText = "编辑快捷方式";
            document.getElementById('modal-add-link').classList.remove('hidden');
            
            document.getElementById('input-link-name').value = link.name;
            document.getElementById('input-link-url').value = link.url;
            
            const previewDiv = document.getElementById('preview-icon');
            const statusText = document.getElementById('upload-status');
            const urlInput = document.getElementById('input-icon-url');
            
            urlInput.value = '';
            document.getElementById('input-link-icon-file').value = '';
            
            const hint = document.getElementById('base-url-hint');
            if(state.iconBaseUrl) hint.classList.remove('hidden'); else hint.classList.add('hidden');

            if (link.customIcon) {
                state.tempIconBase64 = link.customIcon;
                previewDiv.classList.remove('hidden');
                
                let displaySrc = link.customIcon;
                if (!link.customIcon.startsWith('data:') && !link.customIcon.startsWith('http') && state.iconBaseUrl) {
                    displaySrc = state.iconBaseUrl + link.customIcon;
                    urlInput.value = link.customIcon; 
                    statusText.innerText = "已使用仓库文件名";
                } else if (link.customIcon.startsWith('http')) {
                    urlInput.value = link.customIcon;
                    statusText.innerText = "已使用网络图片";
                } else {
                    statusText.innerText = "已使用本地上传图片";
                }
                previewDiv.querySelector('img').src = displaySrc;
            } else {
                state.tempIconBase64 = null;
                previewDiv.classList.add('hidden');
                statusText.innerText = "未选择图标 (默认使用 Google 图标)";
            }
        };

        window.handleUrlInput = (val) => {
            const previewDiv = document.getElementById('preview-icon');
            const statusText = document.getElementById('upload-status');
            
            let fullUrl = val;
            
            if (val && !val.startsWith('http') && !val.startsWith('data:') && state.iconBaseUrl) {
                fullUrl = state.iconBaseUrl + val;
                statusText.innerText = "预览仓库文件 (自动拼接前缀)";
            } else if (val && val.startsWith('http')) {
                statusText.innerText = "预览网络图片";
            }

            if (val) {
                state.tempIconBase64 = val; 
                previewDiv.classList.remove('hidden');
                previewDiv.querySelector('img').src = fullUrl;
                previewDiv.querySelector('img').onerror = () => { statusText.innerText = "预览失败：无法加载图片"; };
            } else if (!val && !document.getElementById('input-link-icon-file').value) {
                previewDiv.classList.add('hidden');
                statusText.innerText = "未选择图标";
                state.tempIconBase64 = null;
            }
        };

        window.handleIconUpload = (e) => { 
            const f=e.target.files[0]; 
            const urlInput = document.getElementById('input-icon-url');
            
            if(!f) return; 
            if(f.size>500*1024){alert("图片需小于500KB，以免拖慢加载");return;} 
            
            urlInput.value = '';
            
            const r=new FileReader(); 
            r.onload=(ev)=>{ 
                state.tempIconBase64=ev.target.result; 
                document.getElementById('preview-icon').classList.remove('hidden'); 
                document.getElementById('preview-icon').querySelector('img').src=state.tempIconBase64; 
                document.getElementById('upload-status').innerText="已选择本地图片"; 
            }; 
            r.readAsDataURL(f); 
        };
        
        window.resetData = () => { if(confirm("重置所有数据？")) { localStorage.clear(); location.reload(); } };

        function toggleEditMode() {
            state.isEditing = !state.isEditing;
            const els = { btn:document.getElementById('btn-edit'), doneBtn:document.getElementById('btn-done'), panel:document.getElementById('edit-panel'), main:document.getElementById('main-container'), search:document.getElementById('search-container') };
            
            if(state.isEditing){
                els.btn.classList.add('hidden');
                els.panel.classList.remove('hidden');
                els.main.classList.add('scale-95', 'opacity-80');
                els.search.classList.add('pointer-events-none', 'opacity-50');
            } else {
                els.btn.classList.remove('hidden');
                els.panel.classList.add('hidden');
                els.main.classList.remove('scale-95', 'opacity-80');
                els.search.classList.remove('pointer-events-none', 'opacity-50');
            }
            renderShortcuts();
        }

        let dragSrcIndex = null;
        
        function getFaviconUrl(url) { 
            return `https://www.google.com/s2/favicons?domain_url=${encodeURIComponent(url)}&sz=128`; 
        }
        
        function getAvatarColorClass(name) { let h=0; for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h); return `avatar-bg-${Math.abs(h)%8}`; }

        function renderShortcuts() {
            const container = document.getElementById('shortcuts-container'); container.innerHTML = '';
            state.shortcuts.forEach((link, index) => {
                const item = document.createElement('div');
                item.className = `relative group flex flex-col items-center gap-2 p-3 rounded-xl transition-all hover:bg-black/5 dark:hover:bg-white/10 ${state.isEditing ? 'cursor-move bg-black/5 dark:bg-white/5 border border-dashed border-gray-300 dark:border-gray-600' : ''}`;
                
                if(state.isEditing){ item.draggable=true; item.ondragstart=(e)=>{dragSrcIndex=index;e.target.classList.add('dragging');}; item.ondragover=(e)=>e.preventDefault(); item.ondrop=(e)=>{const d=state.shortcuts[dragSrcIndex];state.shortcuts.splice(dragSrcIndex,1);state.shortcuts.splice(index,0,d);saveState();renderShortcuts();}; }
                
                let iconContent;
                if(link.customIcon) {
                    let finalSrc = link.customIcon;
                    if (!link.customIcon.startsWith('http') && !link.customIcon.startsWith('data:') && state.iconBaseUrl) {
                        finalSrc = state.iconBaseUrl + link.customIcon;
                    }
                    iconContent = `<img src="${finalSrc}" class="w-full h-full object-contain rounded-full" onerror="this.src='https://via.placeholder.com/64?text=Error'">`;
                } else {
                    const fav = getFaviconUrl(link.url); 
                    const char = (link.name||'L').charAt(0).toUpperCase(); 
                    const col = getAvatarColorClass(link.name||'L');
                    
                    iconContent = `
                        <div class="relative w-full h-full flex items-center justify-center">
                            <div id="fallback-${index}" class="absolute inset-0 flex items-center justify-center text-lg font-bold rounded-full ${col} transition-opacity duration-300">
                                ${char}
                            </div>
                            <img src="${fav}" 
                                 class="relative z-10 w-full h-full object-contain rounded-full opacity-0 transition-opacity duration-500" 
                                 onload="this.style.opacity='1'; document.getElementById('fallback-${index}').style.opacity='0';" 
                                 onerror="this.style.display='none'; document.getElementById('fallback-${index}').style.opacity='1';"
                            >
                        </div>
                    `;
                }
                
                // 核心：点击属性区分 - 正常模式下触发 recordClick
                const clickAttr = state.isEditing 
                    ? `href="javascript:void(0)" onclick="event.preventDefault(); window.openEditLinkModal(${index})"` 
                    : `href="${link.url}" target="_blank" onclick="window.recordClick(${index})"`;

                const itemClass = `flex flex-col items-center gap-3 w-full select-none`;

                const editButtons = state.isEditing ? `
                    <div class="absolute -top-3 -right-3 flex gap-1 z-20">
                        <button onclick="window.openEditLinkModal(${index})" class="bg-blue-600 text-white p-1.5 rounded-full shadow-md hover:scale-110 transition-transform ring-2 ring-white dark:ring-slate-800" title="编辑"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                        <button onclick="window.deleteLink(${index})" class="bg-red-500 text-white p-1.5 rounded-full shadow-md hover:scale-110 transition-transform ring-2 ring-white dark:ring-slate-800" title="删除"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                    </div>
                ` : '';
                
                // 核心：在编辑模式下显示点击次数
                const clickCountBadge = state.isEditing 
                    ? `<div class="absolute -bottom-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-[10px] font-bold rounded-full border border-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-200 dark:border-yellow-800 shadow-sm z-10 flex items-center gap-0.5"><i data-lucide="flame" class="w-3 h-3"></i> ${link.clicks||0}</div>` 
                    : '';

                item.innerHTML = `
                    <a ${clickAttr} class="${itemClass}">
                        <div class="w-14 h-14 rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-2 flex items-center justify-center overflow-hidden shortcut-icon-bg transition-transform group-hover:scale-105 relative">
                            ${iconContent}
                            ${state.isEditing ? '<div class="absolute inset-0 bg-black/10 dark:bg-white/10 flex items-center justify-center"><i data-lucide="pencil" class="w-5 h-5 text-white drop-shadow-md opacity-80"></i></div>' : ''}
                        </div>
                        <span class="text-xs font-medium opacity-80 w-24 text-center truncate dark:text-gray-300">${link.name}</span>
                        ${clickCountBadge}
                    </a>
                    ${editButtons}
                `;
                container.appendChild(item);
            });
            
            if(state.isEditing){
                const addBtn = document.createElement('div'); addBtn.className="flex flex-col items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-black/5 dark:hover:bg-white/10 opacity-60 hover:opacity-100 transition-opacity"; 
                addBtn.onclick=()=>{
                    state.editingIndex = null; 
                    document.getElementById('modal-title').innerText = "添加快捷方式";
                    document.getElementById('modal-add-link').classList.remove('hidden'); 
                    state.tempIconBase64=null; 
                    document.getElementById('input-link-name').value=''; 
                    document.getElementById('input-link-url').value=''; 
                    document.getElementById('input-icon-url').value='';
                    document.getElementById('preview-icon').classList.add('hidden'); 
                    document.getElementById('upload-status').innerText='未选择图标 (默认使用 Google 图标)';
                    const hint = document.getElementById('base-url-hint');
                    if(state.iconBaseUrl) hint.classList.remove('hidden'); else hint.classList.add('hidden');
                };
                addBtn.innerHTML=`<div class="w-14 h-14 rounded-2xl border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center"><i data-lucide="plus" class="w-6 h-6 dark:text-gray-400"></i></div><span class="text-xs font-medium dark:text-gray-400">添加</span>`; container.appendChild(addBtn);
            }
            lucide.createIcons();
        }

        document.getElementById('btn-edit').onclick = toggleEditMode;
        document.getElementById('btn-done').onclick = toggleEditMode;
        document.getElementById('btn-cancel-add').onclick = () => document.getElementById('modal-add-link').classList.add('hidden');
        
        document.getElementById('form-add-link').onsubmit = (e) => { 
            e.preventDefault(); 
            const n = document.getElementById('input-link-name').value; 
            let u = document.getElementById('input-link-url').value; 
            
            if(n && u){ 
                if(!u.startsWith('http')) u='https://'+u; 
                
                const newLinkData = { name:n, url:u, customIcon: state.tempIconBase64, clicks: 0 };
                
                if (state.editingIndex !== null) {
                    // 保留原有点击数
                    newLinkData.clicks = state.shortcuts[state.editingIndex].clicks || 0;
                    state.shortcuts[state.editingIndex] = newLinkData;
                } else {
                    state.shortcuts.push(newLinkData); 
                }
                
                // sortShortcuts(); // 移除：添加后也不排序
                saveState(); 
                renderShortcuts(); 
                document.getElementById('modal-add-link').classList.add('hidden'); 
            } 
        };
        
        document.getElementById('search-form').onsubmit = (e) => { e.preventDefault(); const t=document.getElementById('search-input').value.trim(); if(t) window.location.href=(state.searchEngine==='bing'?'https://www.bing.com/search?q=':'https://www.google.com/search?q=')+encodeURIComponent(t); };
        document.getElementById('form-finance').onsubmit = (e) => { e.preventDefault(); const v=parseFloat(document.getElementById('input-balance').value); if(!isNaN(v)){ state.financeLogs.push({date:new Date().toISOString(), balance:v}); saveFinance(); saveToCloud(); window.openFinanceModal(); } };
        function updateEngineUI() { const btns=document.querySelectorAll('.engine-btn'); btns.forEach(b=>{ const sel=b.dataset.engine===state.searchEngine; b.className=`engine-btn px-3 py-1 rounded-full text-xs font-bold transition-all ${sel?'bg-black text-white dark:bg-white dark:text-black shadow-md':'text-gray-400 hover:text-gray-600 dark:text-slate-500 dark:hover:text-slate-300'}`; }); document.getElementById('search-input').placeholder=`Search ${state.searchEngine==='bing'?'Bing':'Google'}...`; }
        document.querySelectorAll('.engine-btn').forEach(b=>b.onclick=()=>{state.searchEngine=b.dataset.engine; updateEngineUI(); document.getElementById('search-input').focus();});
        document.getElementById('search-input').addEventListener('keydown', (e) => { if(e.key === 'Tab'){ e.preventDefault(); state.searchEngine = state.searchEngine==='bing'?'google':'bing'; updateEngineUI(); } });

        init();
    </script>
</body>
</html>
